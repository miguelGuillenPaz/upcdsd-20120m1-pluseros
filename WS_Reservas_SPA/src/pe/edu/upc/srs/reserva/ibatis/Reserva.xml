<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Reserva">

    <typeAlias alias="reserva" 
               type="pe.edu.upc.srs.reserva.beans.Reserva"/>

    <resultMap id="reservaMap" class="reserva">
        <result property="id" column="id_reserva"/>
        <result property="codigo" column="cod_reserva"/>
        <result property="dia" column="dia_reserva"/>
        <result property="mes" column="mes_reserva"/>
        <result property="anio" column="anio_reserva"/>
        <result property="estado" column="estado"/>
        <result property="horaInicio" column="hora_inicio"/>
        <result property="horaFin" column="hora_fin"/>
        <result property="servicio.descripcion" column="descripcion"/>
        <result property="cliente.nombres" column="nom_cliente"/>
        <result property="cliente.apellidoPaterno" column="ape_pat_cliente"/>
        <result property="cliente.apellidoMaterno" column="ape_mat_cliente"/>
        <result property="empleado.nombres" column="nom_empleado"/>
        <result property="empleado.apellidoPaterno" column="ape_pat_empleado"/>
        <result property="empleado.apellidoMaterno" column="ape_mat_empleado"/>
    </resultMap>

    <parameterMap id="reservaParam" class="reserva">
        <parameter property="dia" mode="IN"/>
        <parameter property="mes" mode="IN"/>
        <parameter property="anio" mode="IN"/>
        <parameter property="servicio.id" mode="IN"/>
        <parameter property="cliente.id" mode="IN"/>
        <parameter property="personal.id" mode="IN"/>
        <parameter property="horaInicio" mode="IN"/>
        <parameter property="horaFin" mode="IN"/>
        <parameter property="codigo" mode="OUT"/>
    </parameterMap>

    <select id="obtenerEmpleadosPorServicio" parameterClass="java.lang.Integer" resultMap="reservaMap">
       SELECT p.valor,
              IFNULL((SELECT 0 FROM srs.reserva r
                       WHERE (r.id_servicio = 1
                         AND r.dia_reserva = '10'
                         AND r.mes_reserva = '02'
                         AND r.anio_reserva = '2012'
                         AND r.estado != 'A'
                         AND ((p.valor + (SELECT s.duracion_horas
                                            FROM srs.servicio s
                                           WHERE s.id_servicio = 1))
                     BETWEEN r.hora_inicio AND r.hora_fin - 1))
                       LIMIT 1),1) habilitado
         FROM srs.parametros p
        WHERE p.tipo = 'HORA'
          AND (p.valor + (SELECT duracion_horas
                            FROM srs.servicio s
                           WHERE s.id_servicio = 1))
         <isLessEqual>
         (SELECT MAX(CAST(pp.valor AS UNSIGNED))
            FROM srs.parametros pp
           WHERE pp.tipo = 'HORA')
         </isLessEqual>
          AND CAST(p.valor AS UNSIGNED) >= IF((CAST(NOW() AS CHAR(10))) = CONCAT('2012','-','01','-','22'),HOUR(CURTIME()) + 2,p.valor)
    </select>

    <select id="obtenerHorariosPorPersonal" parameterClass="java.lang.Integer" resultMap="reservaMap">
    </select>

    <procedure id="sp_registrar_reserva" parameterClass="pe.edu.upc.srs.reserva.beans.Reserva">
        {call sp_registrar_reserva(?,?,?,?,?,?,?,?,?)}
    </procedure>
    
    <procedure id="sp_anular_reserva" parameterClass="java.lang.Integer">
        {call sp_anular_reserva(?)}
    </procedure>
</sqlMap>